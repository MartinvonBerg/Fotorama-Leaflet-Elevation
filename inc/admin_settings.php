<?php

/**
 * Generated by the WordPress Option Page generator and highly adopted by Martin von Berg
 * at http://jeremyhixon.com/wp-tools/option-page/
 */
// use this code for translation: __('string-to-translate', 'fotoramamulti'). Translate the 'string-to-translate' in your po-file

namespace mvbplugins\fotoramamulti;

$path = plugin_dir_path(__FILE__);
require_once $path . 'custom_mine_types.php'; 
require_once $path . 'parseGPX.php'; 

class FotoramaElevation {
	private $fotorama_elevation_options;
	private $fotorama_option2;
	private $up_dir = '';    
	private $min_height_map = 100;
	private $max_height_map = 1000;
	private $min_height_chart = 100;
	private $max_height_chart = 800;
	private $min_width = 100;
	private $max_width = 1500;

	public function __construct() {
		add_action( 'admin_menu', array( $this, 'fotorama_elevation_add_plugin_page' ) );
		add_action( 'admin_init', array( $this, 'fotorama_elevation_page_init' ) );
	}

	public function fotorama_elevation_add_plugin_page() {
		add_options_page(
			'Fotorama-Elevation', // page_title
			'Fotorama-Elevation', // menu_title
			'manage_options', // capability
			'fotorama-elevation', // menu_slug
			array( $this, 'fotorama_elevation_create_admin_page' ) // function
		);
	}

	public function fotorama_elevation_create_admin_page() {
		$this->fotorama_elevation_options = get_option( 'fotorama_elevation_option_name' );
		$this->up_dir = wp_get_upload_dir()['basedir'];     // upload_dir

		?>
		<div class="wrap">
			<h2>Settings for Fotorama-Elevation Plugin</h2>
			<h4>General Settings for the Fotorama Elevation Plugin that are used for every page or post where the Plugin is used. All settings can be overwritten by parameters of the shortcode.</h4>
			<hr>

			<form method="post" action="options.php" enctype="multipart/form-data">
            <?php
			   settings_fields("gpx_section");
			   do_settings_sections("gpx_file");
			   ?>
			   <p><b>Hint: GPX-routes without elevation data should be converted to tracks with <a href="https://www.gpsvisualizer.com/elevation" target="_blank">www.gpsvisualizer.com.</a></br> 
			   Trackdata without elevation will be skipped. Tracksegments will be combined. Routes and waypoints will be ignored. Trackname will be set to filename.</b></br>
			   Button 'Save GPX-File' underneath will save settings and / or GPX-File.</p> 
			   <?php
			   $strg = __('Save GPX-File', 'fotoramamulti');
			   submit_button( $strg );            
            ?>

         	</form>
			<hr>
			<form method="post" action="options.php">
				<?php
					settings_fields( 'fotorama_elevation_option_group' );
					do_settings_sections( 'fotorama-elevation-admin' );
					submit_button();
				?>
			</form>
			
			<hr>
            <h3>List of shortcode Parameters:</h3>
			<p><b>Complete shortcode with the above settings: </br></b> <?php
				$example = '[gpxview imgpath="' . 	$this->fotorama_elevation_options['path_to_images_for_fotorama_0'] . '" ';
				$example.= 'gpxpath="' .            $this->fotorama_elevation_options['path_to_gpx_files_2'] . '" ';
				$example.= 'gpxfile="test.gpx" ';
				$example.= 'showalltracks="' . 		$this->fotorama_elevation_options['showalltracks'] . '" ';
				$example.= 'mapheight="' .          $this->fotorama_elevation_options['height_of_map_10'] . '" ';
				$example.= 'chartheight="' .        $this->fotorama_elevation_options['height_of_chart_11'] . '" ';
				$example.= 'dload="' .              $this->fotorama_elevation_options['download_gpx_files_3'] . '" ';
				$example.= 'alttext="' .            $this->fotorama_elevation_options['general_text_for_the_fotorama_alt_9'] . '" ';
				$example.= 'ignoresort="' .         $this->fotorama_elevation_options['ignore_custom_sort_6'] . '" ';
				$example.= 'useCDN="' .             $this->fotorama_elevation_options['useCDN_13'] . '" ';
				$example.= 'showadress="' .         $this->fotorama_elevation_options['show_address_of_start_7'] . '" ';
				$example.= 'showmap="true" ';
				$example.= 'adresstext="' .         $this->fotorama_elevation_options['text_for_start_address_8'] . '" ';
				$example.= 'requiregps="' .         $this->fotorama_elevation_options['images_with_gps_required_5'] . '" ';
				$example.= 'maxwidth="' .           $this->fotorama_elevation_options['max_width_of_container_12'] . '" ';
				$example.= 'minrowwidth="' .        $this->fotorama_elevation_options['min_width_css_grid_row_14'] . '" ';
				$example.= 'showcaption="' .        $this->fotorama_elevation_options['show_caption_4'] . '" ';
				$example.= 'eletheme="' .           $this->fotorama_elevation_options['colour_theme_for_leaflet_elevation_1'] . '" ';
				$example.= 'mapcenter="' . 			($this->fotorama_elevation_options['mapcenter'] ?? '48.12,12.35') . '" ';
				$example.= 'zoom="' . 				($this->fotorama_elevation_options['zoom'] ?? '8') . '" ';
				$example.= 'markertext="' . 		($this->fotorama_elevation_options['markertext'] ?? 'My Address') . '" ';
				$example.= 'fit="' .				($this->fotorama_elevation_options['fit'] ?? 'cover') . '" '; // 'contain' Default, 'cover', 'scaledown', 'none'
				$example.= 'ratio="' .				($this->fotorama_elevation_options['ratio'] ?? '1.5') . '" ';
				$example.= 'background="' .			($this->fotorama_elevation_options['background'] ?? 'darkgrey') . '" '; // background color in CSS name
				$example.= 'nav="' .				($this->fotorama_elevation_options['nav'] ?? 'thumbs') . '" '; // Default: 'dots', 'thumbs') . '" '; false, // funktioniert nicht
				$example.= 'navposition="' .		($this->fotorama_elevation_options['navposition'] ?? 'bottom') . '" '; // 'top'
				$example.= 'navwidth="' .			($this->fotorama_elevation_options['navwidth'] ?? '100%') . '" '; // in percent
				$example.= 'f_thumbwidth="' .		($this->fotorama_elevation_options['f_thumbwidth'] ?? '100') . '" '; // in pixels
				$example.= 'f_thumbheight="' .		($this->fotorama_elevation_options['f_thumbheight'] ?? '75') . '" '; // in pixels
				$example.= 'thumbmargin="' .		($this->fotorama_elevation_options['thumbmargin'] ?? '2') . '" '; // in pixels
				$example.= 'thumbborderwidth="' .	($this->fotorama_elevation_options['thumbborderwidth'] ?? '2') . '" '; // in pixels
				$example.= 'thumbbordercolor="' .	($this->fotorama_elevation_options['thumbbordercolor'] ?? '#ea0000') . '" '; // background color in CSS name or HEX-value. The color of the last shortcode on the page will be taken.
				$example.= 'transition="' .			($this->fotorama_elevation_options['transition'] ?? 'crossfade') . '" '; // 'slide' Default 'crossfade' 'dissolve'
				$example.= 'transitionduration="' .	($this->fotorama_elevation_options['transitionduration'] ?? '400') . '" '; // in ms
				$example.= 'loop="' .				($this->fotorama_elevation_options['loop'] ?? 'true') . '" '; // true or false
				$example.= 'autoplay="' .			($this->fotorama_elevation_options['autoplay'] ?? '3000') . '" '; // on with 'true' or any interval in milliseconds.
				$example.= 'arrows="' .				($this->fotorama_elevation_options['arrows'] ?? 'true') . '" ';  // true : Default, false, 'always' : Do not hide controls on hover or tap
				$example.= 'shadows="' .			($this->fotorama_elevation_options['shadows'] ?? 'true') . '"]'; // true or false
			 	echo $example;
			?></p>

			<style type="text/css">
				.tg  {border-collapse:collapse;border-spacing:2;background-color: white;}
				.tg td{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
				overflow:hidden;padding:10px 5px;word-break:normal;}
				.tg th{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
				font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}
				.tg .tg-dncm{border-color:inherit;font-weight:bold;position:-webkit-sticky;position:sticky;text-align:left;top:-1px;
				vertical-align:top;will-change:transform;background-color: goldenrod;}
				.tg .tg-0pky{border-color:inherit;text-align:left;vertical-align:top}
				.tg tr:nth-child(even) {background-color:lightgray;}
			</style>

			<table class="tg">
				<thead>
				<tr>
					<th class="tg-dncm">Shortcode</th>
					<th class="tg-dncm">Value (Default first)</th>
					<th class="tg-dncm">Example</th>
					<th class="tg-dncm">Description</th>
				</tr>
				</thead>
				<tbody>
				<tr>
					<td class="tg-0pky">gpxpath</td>
					<td class="tg-0pky">gpx</td>
					<td class="tg-0pky">gpxpath="gpx"</td>
					<td class="tg-0pky">Path to file(s) with GPX-Track(s) relative to the Wordpress uploads folder, e.g: ../wordpress/wp-content/uploads/gpx</td>
				</tr>
				<tr>
					<td class="tg-0pky">gpxfile</td>
					<td class="tg-0pky">'' / test.gpx</td>
					<td class="tg-0pky">gpxfile="test.gpx"</td>
					<td class="tg-0pky">File with gpx-track, e.g: ../wordpress/wp-content/uploads/gpx/test.gpx. Use comma seperated list for multiple file: "f1.gpx, f2.gpx, f3.gpx"</td>
				</tr>
				<tr>
					<td class="tg-0pky">dload</td>
					<td class="tg-0pky">yes / no</td>
					<td class="tg-0pky">dload="yes"</td>
					<td class="tg-0pky">Provide download link for the GPX-Tracks, if "yes".</td>
				</tr>
				<tr>
					<td class="tg-0pky">showalltracks</td>
					<td class="tg-0pky">false / true </td>
					<td class="tg-0pky">showalltracks="true"</td>
					<td class="tg-0pky">Show all given tracks together in one Map. Works only with one map!. Will be ignored for multiple maps or if only one track is provided. There is no admin-setting for this option.</td>
				</tr>
				<tr>
					<td class="tg-0pky">showadress</td>
					<td class="tg-0pky">true / false</td>
					<td class="tg-0pky">showadress="true"</td>
					<td class="tg-0pky">Show start adress of the tour. GPX-coords are taken from the first point in the GPX-track or from the first image.</td>
				</tr>
				<tr>
					<td class="tg-0pky">adresstext</td>
					<td class="tg-0pky">Startadresse</td>
					<td class="tg-0pky">adresstext="Startadresse"</td>
					<td class="tg-0pky">Text for header above start address</td>
				</tr>
				<tr>
					<td class="tg-0pky">showmap</td>
					<td class="tg-0pky">true / false</td>
					<td class="tg-0pky">showmap="true"</td>
					<td class="tg-0pky">Show the map, independent of other settinges. Currently no Admin setting for that.</td>
				</tr>
				<tr>
					<td class="tg-0pky">mapheight</td>
					<td class="tg-0pky">450</td>
					<td class="tg-0pky">mapheight="450"</td>
					<td class="tg-0pky">Height of the leaflet map in pixels (px)</td>
				</tr>
				<tr>
					<td class="tg-0pky">chartheight</td>
					<td class="tg-0pky">200</td>
					<td class="tg-0pky">chartheight="200"</td>
					<td class="tg-0pky">Height of the leaflet elevation chart in pixels (px)</td>
				</tr>
				<tr>
					<td class="tg-0pky">eletheme</td>
					<td class="tg-0pky">lime-theme</td>
					<td class="tg-0pky">eletheme="lime-theme"</td>
					<td class="tg-0pky">Theme for leaflet elevation. Other themes are: steelblue-theme, purple-theme, yellow-theme, red-theme, magenta-theme, lightblue-theme and martin-theme. Martin-theme is my special theme.</td>
				</tr>
				<tr>
					<td class="tg-0pky">mapcenter</td>
					<td class="tg-0pky">0.0,0.0</td>
					<td class="tg-0pky">mapcenter="48.12,12.35"</td>
					<td class="tg-0pky">Center of the map if NO tracks are defined. Usa comma "," for separation and dot "." for decimals. There is no admin-setting for this option.</td>
				</tr>
				<tr>
					<td class="tg-0pky">zoom</td>
					<td class="tg-0pky">8</td>
					<td class="tg-0pky">zoom="8"</td>
					<td class="tg-0pky">Zoom level for the map if NO tracks are defined. There is no admin-setting for this option.</td>
				</tr>
				<tr>
					<td class="tg-0pky">markertext</td>
					<td class="tg-0pky">Home Address</td>
					<td class="tg-0pky">markertext="My Address"</td>
					<td class="tg-0pky">Tooltip text for the marker that is shown at mouse over. There is no admin-setting for this option.</td>
				</tr>
				<tr>
				<td class="tg-0pky"><strong>Fotorama Settings</strong></td><td></td><td></td><td></td>
				</tr>
				<tr>
					<td class="tg-0pky">imgpath</td>
					<td class="tg-0pky">Bilder</td>
					<td class="tg-0pky">imgpath="Bilder"</td>
					<td class="tg-0pky">Path the images relative to the Wordpress uploads folder, e.g: ../wordpress/wp-content/uploads/galleries/holiday2020</td>
				</tr>
				<tr>
					<td class="tg-0pky">alttext</td>
					<td class="tg-0pky">''</td>
					<td class="tg-0pky">alttext="Image Slider with map from holiday"</td>
					<td class="tg-0pky">Alltext for the fotorama slider for SEO</td>
				</tr>
				<tr>
					<td class="tg-0pky">ignoresort</td>
					<td class="tg-0pky">false / true</td>
					<td class="tg-0pky">ignoresort="false"</td>
					<td class="tg-0pky">Ignore custom sort even if provided by Wordpress. If checked sort by date ascending</td>
				</tr>
			
				<tr>
					<td class="tg-0pky">requiregps</td>
					<td class="tg-0pky">true / false</td>
					<td class="tg-0pky">requiregps="true"</td>
					<td class="tg-0pky">Require images to have GPS-data in EXIF. Show image only if it provides GPS-Data in its EXIF.</td>
				</tr>
				<tr>
					<td class="tg-0pky">maxwidth</td>
					<td class="tg-0pky">600</td>
					<td class="tg-0pky">maxwidth="600"</td>
					<td class="tg-0pky">Maximum width of the whole container with slider and map</td>
				</tr>
				<tr>
					<td class="tg-0pky">minrowwidth</td>
					<td class="tg-0pky">480</td>
					<td class="tg-0pky">minrowwidth="480"</td>
					<td class="tg-0pky">Minimum width of one row of the CSS-Grid. If greater than maxwidth/2 Fotorama and the map are never shown in one row. 
										Mind that the max. width of the outer div may be inherited from other elements or set by the theme.</td>
				</tr>
				<tr>
					<td class="tg-0pky">showcaption</td>
					<td class="tg-0pky">true / false</td>
					<td class="tg-0pky">showcaption="true"</td>
					<td class="tg-0pky">Show the caption in the fotorama slider</td>
				</tr>
				<tr>
					<td class="tg-0pky">useCDN</td>
					<td class="tg-0pky">false / true</td>
					<td class="tg-0pky">useCDN="false"</td>
					<td class="tg-0pky">Use CDN for js- and css-Library-Files</td>
				</tr>
				<tr>
				<td class="tg-0pky"><strong>Fotorama without admin settings</strong></td><td></td><td></td><td></td>
				</tr>
				<tr><td class="tg-0pky">fit</td><td class="tg-0pky">contain , cover, scaledown, none</td><td class="tg-0pky">fit="contain"</td><td class="tg-0pky">Define the scaling of Fotos for the Fotorama Slider</td></tr>
				<tr><td class="tg-0pky">ratio</td><td class="tg-0pky">1.5</td><td class="tg-0pky">ratio="1.0"</td><td class="tg-0pky">Define the width / height ratio of the Fotorama slider. Smaller ratio means greater height of the Slider. No checking of values up to now</td></tr>
				<tr><td class="tg-0pky">background</td><td class="tg-0pky">darkgrey</td><td class="tg-0pky">background="red"</td><td class="tg-0pky">Background color of the slider defined by a valid CSS name</td></tr>
				<tr><td class="tg-0pky">navposition</td><td class="tg-0pky">bottom , top</td><td class="tg-0pky">navposition="top"</td><td class="tg-0pky">Position of the navigation bar</td></tr>
				<tr><td class="tg-0pky">navwidth</td><td class="tg-0pky">100%</td><td class="tg-0pky">navwidth="80%"</td><td class="tg-0pky">Width of the navigation bar in percent. Provide the '%' also!.</td></tr>
				<tr><td class="tg-0pky">f_thumbwidth</td><td class="tg-0pky">100</td><td class="tg-0pky">f_thumbwidth="80"</td><td class="tg-0pky">Width of the single thumbnail in the navigation bar in pixels</td></tr>
				<tr><td class="tg-0pky">f_thumbheight</td><td class="tg-0pky">75</td><td class="tg-0pky">f_thumbheight="80"</td><td class="tg-0pky">Height of the single thumbnail in the navigation bar in pixels</td></tr>
				<tr><td class="tg-0pky">thumbmargin</td><td class="tg-0pky">2</td><td class="tg-0pky">thumbmargin="3"</td><td class="tg-0pky">Margin between thumbnails in pixels</td></tr>
				<tr><td class="tg-0pky">thumbborderwidth</td><td class="tg-0pky">2</td><td class="tg-0pky">thumbborderwidth="3"</td><td class="tg-0pky">Width of the coloured thumbnail border in pixels</td></tr>
				<tr><td class="tg-0pky">thumbbordercolor</td><td class="tg-0pky">#ea0000</td><td class="tg-0pky">thumbbordercolor="blue"</td><td class="tg-0pky">Color of thumbnail border in CSS name or HEX-value with #!. Attention: If there are multiple shortcodes on the page, the color of the LAST shortcode on the page will be taken.</td></tr>
				<tr><td class="tg-0pky">transition</td><td class="tg-0pky">crossfade , slide , dissolve</td><td class="tg-0pky">transition="slide"</td><td class="tg-0pky">Type of transition between images</td></tr>
				<tr><td class="tg-0pky">transitionduration</td><td class="tg-0pky">400</td><td class="tg-0pky">transitionduration="200"</td><td class="tg-0pky">Duration of transition in ms</td></tr>
				<tr><td class="tg-0pky">loop</td><td class="tg-0pky">true , false</td><td class="tg-0pky">loop="false"</td><td class="tg-0pky">Loop through images (proceed with first once the reached the las) true or false</td></tr>
				<tr><td class="tg-0pky">autoplay</td><td class="tg-0pky">3000</td><td class="tg-0pky">autoplay="false"</td><td class="tg-0pky">Autoplay or loop the slider. On with "true" or any numeric interval in milliseconds. Of with "false"</td></tr>
				<tr><td class="tg-0pky">arrows</td><td class="tg-0pky">true , false , always</td><td class="tg-0pky">arrows="false"</td><td class="tg-0pky">Show arrows for the slider control. 'always' : Do not hide controls on hover or tap</td></tr>
			
				</tbody>
			</table>

		</div>
		<?php 
	}

	public function fotorama_elevation_page_init() { // == demo_settings_page()
		register_setting(
			'fotorama_elevation_option_group', // option_group
			'fotorama_elevation_option_name', // option_name
			array( $this, 'fotorama_elevation_sanitize' ) // sanitize_callback
		);
		// ------------ Fotorama Section
		add_settings_section(
			'fotorama_elevation_setting_section', // id
			'Fotorama Settings', // title
			array( $this, 'fotorama_elevation_section_info' ), // callback
			'fotorama-elevation-admin' // page
		);

		add_settings_field(
			'path_to_images_for_fotorama_0', // id
			'Path to Images for Fotorama', // title
			array( $this, 'path_to_images_for_fotorama_0_callback' ), // callback
			'fotorama-elevation-admin', // page
			'fotorama_elevation_setting_section' // section
        );
        
        add_settings_field(
			'show_caption_4', // id
			'Show Caption', // title
			array( $this, 'show_caption_4_callback' ), // callback
			'fotorama-elevation-admin', // page
			'fotorama_elevation_setting_section' // section
        );
        
        add_settings_field(
			'images_with_gps_required_5', // id
			'Images with GPS required', // title
			array( $this, 'images_with_gps_required_5_callback' ), // callback
			'fotorama-elevation-admin', // page
			'fotorama_elevation_setting_section' // section
		);

		add_settings_field(
			'ignore_custom_sort_6', // id
			'Ignore custom sort', // title
			array( $this, 'ignore_custom_sort_6_callback' ), // callback
			'fotorama-elevation-admin', // page
			'fotorama_elevation_setting_section' // section
        );

        add_settings_field(
			'general_text_for_the_fotorama_alt_9', // id
			'General text for the Fotorama alt', // title
			array( $this, 'general_text_for_the_fotorama_alt_9_callback' ), // callback
			'fotorama-elevation-admin', // page
			'fotorama_elevation_setting_section' // section
		);

		add_settings_field(
			'useCDN_13', // id
			'Use CDN', // title
			array( $this, 'useCDN_13_callback' ), // callback
			'fotorama-elevation-admin', // page
			'fotorama_elevation_setting_section' // section
        );

		add_settings_field(
			'setCustomFields_15', // id
			'Set Custom Fields for post', // title
			array( $this, 'setCustomFields_15_callback' ), // callback
			'fotorama-elevation-admin', // page
			'fotorama_elevation_setting_section' // section
        );

		add_settings_field(
			'doYoastXmlSitemap_16', // id
			'Generate Entries in Yoast XML-Sitemap for Fotorama Images', // title
			array( $this, 'doYoastXmlSitemap_16_callback' ), // callback
			'fotorama-elevation-admin', // page
			'fotorama_elevation_setting_section' // section
        );

        // ---------- Leaflet Elevation Settings Section
        add_settings_section(
			'leaflet_elevation_setting_section', // id
			'Leaflet Elevation Settings', // title
			array( $this, 'leaflet_elevation_section_info' ), // callback
			'fotorama-elevation-admin' // page
		);

		add_settings_field(
			'colour_theme_for_leaflet_elevation_1', // id
			'Colour Theme for Leaflet Elevation', // title
			array( $this, 'colour_theme_for_leaflet_elevation_1_callback' ), // callback
			'fotorama-elevation-admin', // page
			'leaflet_elevation_setting_section' // section
		);

		add_settings_field(
			'path_to_gpx_files_2', // id
			'Path to GPX-Files', // title
			array( $this, 'path_to_gpx_files_2_callback' ), // callback
			'fotorama-elevation-admin', // page
			'leaflet_elevation_setting_section' // section
		);

		add_settings_field(
			'download_gpx_files_3', // id
			'Download GPX-Files', // title
			array( $this, 'download_gpx_files_3_callback' ), // callback
			'fotorama-elevation-admin', // page
			'leaflet_elevation_setting_section' // section
		);

		add_settings_field(
			'show_address_of_start_7', // id
			'Show Address', // title
			array( $this, 'show_address_of_start_7_callback' ), // callback
			'fotorama-elevation-admin', // page
			'leaflet_elevation_setting_section' // section
		);

		add_settings_field(
			'text_for_start_address_8', // id
			'Text for Start address', // title
			array( $this, 'text_for_start_address_8_callback' ), // callback
			'fotorama-elevation-admin', // page
			'leaflet_elevation_setting_section' // section
		);

		add_settings_field(
			'height_of_map_10', // id
			'Height of Map in px', // title
			array( $this, 'height_of_map_10_callback' ), // callback
			'fotorama-elevation-admin', // page
			'leaflet_elevation_setting_section' // section
		);

		add_settings_field(
			'height_of_chart_11', // id
			'Height of Chart in px', // title
			array( $this, 'height_of_chart_11_callback' ), // callback
			'fotorama-elevation-admin', // page
			'leaflet_elevation_setting_section' // section
		);

		add_settings_field(
			'max_width_of_container_12', // id
			'Max Width of Container in px', // title
			array( $this, 'max_width_of_container_12_callback' ), // callback
			'fotorama-elevation-admin', // page
			'leaflet_elevation_setting_section' // section
		);

		add_settings_field(
			'min_width_css_grid_row_14', // id
			'Min Width of one CSS-grid Row in px', // title
			array( $this, 'min_width_css_grid_row_14_callback' ), // callback
			'fotorama-elevation-admin', // page
			'leaflet_elevation_setting_section' // section
		);

		add_settings_field(
			'fit', // id
			'How to fit the images in Fotorama', // title
			array( $this, 'fit_callback' ), // xy_callback erstellen und fotorama_elevation_sanitize function anpassen
			'fotorama-elevation-admin', // page
			'leaflet_elevation_setting_section' // section
		);

		// --------------- GPX-Section --------------------------------------------------------
		add_settings_section("gpx_section", __('GPX-File', 'fotoramamulti') . ' upload', null, "gpx_file");
    	add_settings_field("gpx-file", __('GPX-File', 'fotoramamulti') , array( $this, "gpx_file_callback"), "gpx_file", "gpx_section");  
		register_setting("gpx_section", "gpx-file", array( $this, "handle_file_upload") );

		add_settings_field(
			'gpx_reduce', // id
			__('GPX-Parsing', 'fotoramamulti'), // title
			array( $this, 'gpx_reduce_callback' ), // callback
			'gpx_file', // page
			'gpx_section' // section
		);

		add_settings_field(
			'gpx_smooth', // id
			__('Distance-Smooth', 'fotoramamulti'), // title
			array( $this, 'gpx_smooth_callback' ), // callback
			'gpx_file', // page
			'gpx_section' // section
		);

		add_settings_field(
			'gpx_elesmooth', // id
			__('Elevation-Smooth', 'fotoramamulti'), // title
			array( $this, 'gpx_elesmooth_callback' ), // callback
			'gpx_file', // page
			'gpx_section' // section
		);

		add_settings_field(
			'gpx_overwrite', // id
			__('Overwrite GPX-Track', 'fotoramamulti'), // title
			array( $this, 'gpx_overwrite_callback' ), // callback
			'gpx_file', // page
			'gpx_section' // section
		);
		// Database options for GPX-File-Upload Section. not quite correct but we are in the admin_init hook
		if ( ! get_option('fotorama_option2')){
			$this->fotorama_option2 = array(
				'gpx_reduce' => true,
				'gpx_smooth' => 25, // Distance smooth in meters
				'gpx_elesmooth' => 4, // Elevation smooth in meters
				'gpx_overwrite' => true);
			add_option('fotorama_option2', $this->fotorama_option2);
			} else {
				$this->fotorama_option2 = get_option('fotorama_option2');
		}
		
	}
	
	public function gpx_file_callback() {
		?><input type="file" name="gpx-file" /><?php // create html button for file name
		echo ('</br>Upload' .  get_option('gpx-file') );
	}

	public function gpx_reduce_callback() {
		printf(
			'<input type="checkbox" name="gpx-file[gpx_reduce]" id="gpx_reduce" value="gpx_reduce" %s><label for="gpx_reduce">%s %s</label>',
			( $this->fotorama_option2['gpx_reduce'] === 'true' ) ? 'checked' : '',
			__('Reduce and add Metadata to', 'fotoramamulti'), 
			__('GPX-File', 'fotoramamulti')
		);
	}

	public function gpx_smooth_callback() {
		$this->fotorama_option2 = get_option('fotorama_option2');
		printf(
			'<input type="number" min="1" max="50" name="gpx-file[gpx_smooth]" id="gpx_smooth" value=%s><label> Min. Distance of Track-Points in Meters</label>',
			isset( $this->fotorama_option2['gpx_smooth'] ) ? esc_attr( $this->fotorama_option2['gpx_smooth']): ''
		);
	}

	public function gpx_elesmooth_callback() {
		$this->fotorama_option2 = get_option('fotorama_option2');
		printf(
			'<input type="number" min="1" max="50" name="gpx-file[gpx_elesmooth]" id="gpx_elesmooth" value=%s><label> Min. Elevation between Track-Points in Meters. Used in Statistics Calc only. Best is 4.</label>',
			isset( $this->fotorama_option2['gpx_elesmooth'] ) ? esc_attr( $this->fotorama_option2['gpx_elesmooth']): ''
		);
	}

	public function gpx_overwrite_callback() {
		printf(
			'<input type="checkbox" name="gpx-file[gpx_overwrite]" id="gpx_overwrite" value="gpx_overwrite" %s><label for="gpx_overwrite">Overwrite existing GPX-File</label>',
			( $this->fotorama_option2['gpx_overwrite'] === 'true' ) ? 'checked' : ''
		);
	}

	public function handle_file_upload($option) { 

		$this->fotorama_elevation_options = get_option( 'fotorama_elevation_option_name' );
		$this->fotorama_option2 = get_option('fotorama_option2');
		$this->up_dir = wp_get_upload_dir()['basedir'];     // upload_dir

		$parsegpxfile = $option["gpx_reduce"] == 'gpx_reduce';
		$parsegpxfile ? $this->fotorama_option2['gpx_reduce'] = 'true' : $this->fotorama_option2['gpx_reduce'] = 'false';

		$overwrite = $option["gpx_overwrite"] == 'gpx_overwrite';
		$overwrite ? $this->fotorama_option2['gpx_overwrite'] = 'true' : $this->fotorama_option2['gpx_overwrite'] = 'false';
		//$success = update_option( 'fotorama_elevation_option_name', $this->fotorama_elevation_options );

		$this->fotorama_option2['gpx_smooth'] = intval($option["gpx_smooth"]);	
		$smooth = $this->fotorama_option2['gpx_smooth'];

		$this->fotorama_option2['gpx_elesmooth'] = intval($option["gpx_elesmooth"]);	
		$elesmooth = $this->fotorama_option2['gpx_elesmooth'];		
			
		update_option( 'fotorama_option2', $this->fotorama_option2 );

		$file = $_FILES['gpx-file']['name'];
		$path = $this->up_dir . '/' . $this->fotorama_elevation_options['path_to_gpx_files_2'];
		$complete = $path . '/' . $file;

		if( is_dir($path) ) {
			//echo "The Directory {$path} exists";
		} else {
			mkdir($path , 0777);
			//echo "The Directory {$path} was created";
		}

		if( (! is_file($complete) || ($overwrite) ) && ($file != '')) {
			$name_file = $_FILES['gpx-file']['name'];
			$tmp_name = $_FILES['gpx-file']['tmp_name']; 

			if ($parsegpxfile) { 
				$values = parsegpx ($tmp_name, $path, $name_file, $smooth, $elesmooth);
				$result = strpos($values, 'Skip') == false;
			} else {
				$result = move_uploaded_file( $tmp_name, $path. '/'.$name_file );
				$values = 'File not touched!';
			}

			if( $result )  {
				$temp = ' of "'. $name_file . '" successful! </br> With: ' . $values;
			} else {
				$temp = ". The file was not uploaded. " . $values;
			}

			return $temp;  
		}
		
		if ($file == '') { $temp = '. No Filename given!';}
		else { $temp = "File alread exists!"; }

		return $temp;
	}

	public function fotorama_elevation_sanitize($input) {
		$sanitary_values = array();
		if ( isset( $input['path_to_images_for_fotorama_0'] ) ) {
			$sanitary_values['path_to_images_for_fotorama_0'] = $this->my_sanitize_path( $input['path_to_images_for_fotorama_0'] );
		}

		if ( isset( $input['colour_theme_for_leaflet_elevation_1'] ) ) {
			$sanitary_values['colour_theme_for_leaflet_elevation_1'] = $input['colour_theme_for_leaflet_elevation_1'];
		}

		if ( isset( $input['path_to_gpx_files_2'] ) ) {
			$sanitary_values['path_to_gpx_files_2'] = $this->my_sanitize_path( $input['path_to_gpx_files_2'] );
		}

		if ( isset( $input['download_gpx_files_3'] ) ) { // wird nur durchlaufen, wenn button gecheckt ist, sonst nicht.
			$sanitary_values['download_gpx_files_3'] = 'true';
		} else {
			$sanitary_values['download_gpx_files_3'] = 'false';
		}

		if ( isset( $input['show_caption_4'] ) ) {
			$sanitary_values['show_caption_4'] = 'true';
		} else {
			$sanitary_values['show_caption_4'] = 'false';
		}

		if ( isset( $input['images_with_gps_required_5'] ) ) {
			$sanitary_values['images_with_gps_required_5'] = 'true';
		} else {
			$sanitary_values['images_with_gps_required_5'] = 'false';
		}

		if ( isset( $input['ignore_custom_sort_6'] ) ) {
			$sanitary_values['ignore_custom_sort_6'] = 'true';
		} else {
			$sanitary_values['ignore_custom_sort_6'] = 'false';
		}

		if ( isset( $input['show_address_of_start_7'] ) ) {
			$sanitary_values['show_address_of_start_7'] = 'true';
		} else {
			$sanitary_values['show_address_of_start_7'] = 'false';
		}

		if ( isset( $input['text_for_start_address_8'] ) ) {
			$sanitary_values['text_for_start_address_8'] = $this->my_sanitize_text( $input['text_for_start_address_8'] );
		}

		if ( isset( $input['general_text_for_the_fotorama_alt_9'] ) ) {
			$sanitary_values['general_text_for_the_fotorama_alt_9'] = $this->my_sanitize_text( $input['general_text_for_the_fotorama_alt_9'] );
		}

		if ( isset( $input['height_of_map_10'] ) ) {
			$sanitary_values['height_of_map_10'] = $this->my_sanitize_int_with_limits($input['height_of_map_10'], $this->min_height_map, $this->max_height_map );
		}

		if ( isset( $input['height_of_chart_11'] ) ) {
			$sanitary_values['height_of_chart_11'] = $this->my_sanitize_int_with_limits($input['height_of_chart_11'], $this->min_height_chart, $this->max_height_chart );
		}

		if ( isset( $input['max_width_of_container_12'] ) ) {
			$sanitary_values['max_width_of_container_12'] = $this->my_sanitize_int_with_limits($input['max_width_of_container_12'], $this->min_width, $this->max_width );
		}

		if ( isset( $input['useCDN_13'] ) ) {
			$sanitary_values['useCDN_13'] = 'true';
		} else {
			$sanitary_values['useCDN_13'] = 'false';
		}

		if ( isset( $input['min_width_css_grid_row_14'] ) ) {
			$sanitary_values['min_width_css_grid_row_14'] = $this->my_sanitize_int_with_limits($input['min_width_css_grid_row_14'], $this->min_width/2, $this->max_width );
		}

		if ( isset( $input['setCustomFields_15'] ) ) {
			$sanitary_values['setCustomFields_15'] = 'true';
		} else {
			$sanitary_values['setCustomFields_15'] = 'false';
		}

		if ( isset( $input['doYoastXmlSitemap_16'] ) ) {
			$sanitary_values['doYoastXmlSitemap_16'] = 'true';
		} else {
			$sanitary_values['doYoastXmlSitemap_16'] = 'false';
		}

		if ( isset( $input['fit'] ) ) {
			$sanitary_values['fit'] = $input['fit'];
		}

		$sanitary_values['gpx_file'] = $input['gpx_file'] ;

		return $sanitary_values;
	}

	public function fotorama_elevation_section_info() {	
		// html code here is shown after the heading of the section
    }
    
    public function leaflet_elevation_section_info() {
	}

	public function path_to_images_for_fotorama_0_callback() {
		printf(
			'<input class="regular-text" type="text" placeholder="Define path without leading and trailing slashes" name="fotorama_elevation_option_name[path_to_images_for_fotorama_0]" id="path_to_images_for_fotorama_0" value="%s"><p>%s</p>',
			isset( $this->fotorama_elevation_options['path_to_images_for_fotorama_0'] ) ? esc_attr( $this->fotorama_elevation_options['path_to_images_for_fotorama_0']) : '',
			$this->up_dir . '/' . $this->fotorama_elevation_options['path_to_images_for_fotorama_0']
		);
	}

	public function colour_theme_for_leaflet_elevation_1_callback() {
		?> <select name="fotorama_elevation_option_name[colour_theme_for_leaflet_elevation_1]" id="colour_theme_for_leaflet_elevation_1">
			<?php $selected = (isset( $this->fotorama_elevation_options['colour_theme_for_leaflet_elevation_1'] ) && $this->fotorama_elevation_options['colour_theme_for_leaflet_elevation_1'] === 'martin-theme') ? 'selected' : '' ; ?>
			<option value="martin-theme" <?php echo $selected; ?>>Martin</option>
			<?php $selected = (isset( $this->fotorama_elevation_options['colour_theme_for_leaflet_elevation_1'] ) && $this->fotorama_elevation_options['colour_theme_for_leaflet_elevation_1'] === 'lime-theme') ? 'selected' : '' ; ?>
			<option value="lime-theme" <?php echo $selected; ?>>Lime</option>
			<?php $selected = (isset( $this->fotorama_elevation_options['colour_theme_for_leaflet_elevation_1'] ) && $this->fotorama_elevation_options['colour_theme_for_leaflet_elevation_1'] === 'steelblue-theme') ? 'selected' : '' ; ?>
			<option value="steelblue-theme" <?php echo $selected; ?>>Steelblue </option>
			<?php $selected = (isset( $this->fotorama_elevation_options['colour_theme_for_leaflet_elevation_1'] ) && $this->fotorama_elevation_options['colour_theme_for_leaflet_elevation_1'] === 'purple-theme') ? 'selected' : '' ; ?>
			<option value="purple-theme" <?php echo $selected; ?>>Purple</option>
			<?php $selected = (isset( $this->fotorama_elevation_options['colour_theme_for_leaflet_elevation_1'] ) && $this->fotorama_elevation_options['colour_theme_for_leaflet_elevation_1'] === 'yellow-theme') ? 'selected' : '' ; ?>
			<option value="yellow-theme" <?php echo $selected; ?>>Yellow</option>
			<?php $selected = (isset( $this->fotorama_elevation_options['colour_theme_for_leaflet_elevation_1'] ) && $this->fotorama_elevation_options['colour_theme_for_leaflet_elevation_1'] === 'red-theme') ? 'selected' : '' ; ?>
			<option value="red-theme" <?php echo $selected; ?>>Red</option>
			<?php $selected = (isset( $this->fotorama_elevation_options['colour_theme_for_leaflet_elevation_1'] ) && $this->fotorama_elevation_options['colour_theme_for_leaflet_elevation_1'] === 'magenta-theme') ? 'selected' : '' ; ?>
			<option value="magenta-theme" <?php echo $selected; ?>>Magenta </option>
			<?php $selected = (isset( $this->fotorama_elevation_options['colour_theme_for_leaflet_elevation_1'] ) && $this->fotorama_elevation_options['colour_theme_for_leaflet_elevation_1'] === 'lightblue-theme') ? 'selected' : '' ; ?>
			<option value="lightblue-theme" <?php echo $selected; ?>>Lightblue</option>
		</select> <?php
	}

	public function path_to_gpx_files_2_callback() {
		printf(
			'<input class="regular-text" type="text" placeholder="Define path without leading and trailing slashes" name="fotorama_elevation_option_name[path_to_gpx_files_2]" id="path_to_gpx_files_2" value="%s"><p>%s</p>',
			isset( $this->fotorama_elevation_options['path_to_gpx_files_2'] ) ? esc_attr( $this->fotorama_elevation_options['path_to_gpx_files_2']) : '', 
			$this->up_dir . '/' . $this->fotorama_elevation_options['path_to_gpx_files_2']
		);
	}

	public function download_gpx_files_3_callback() {
		$param = 1;
		printf(
			'<input type="checkbox" name="fotorama_elevation_option_name[download_gpx_files_3]" id="download_gpx_files_3" value="download_gpx_files_3" %s> <label for="download_gpx_files_3">Provide download link for GPX-Files</label>',
			( isset( $this->fotorama_elevation_options['download_gpx_files_3'] ) && $this->fotorama_elevation_options['download_gpx_files_3'] === 'true' ) ? 'checked' : '' 
		);
	}

	public function show_caption_4_callback() {
		printf(
			'<input type="checkbox" name="fotorama_elevation_option_name[show_caption_4]" id="show_caption_4" value="show_caption_4" %s> <label for="show_caption_4">Show the Caption in Fotorama</label>',
			( isset( $this->fotorama_elevation_options['show_caption_4'] ) && $this->fotorama_elevation_options['show_caption_4'] === 'true' ) ? 'checked' : ''
		);
	}

	public function images_with_gps_required_5_callback() {
		printf(
			'<input type="checkbox" name="fotorama_elevation_option_name[images_with_gps_required_5]" id="images_with_gps_required_5" value="images_with_gps_required_5" %s> <label for="images_with_gps_required_5">Show images only if they provide GPS-Data in EXIF</label>',
			( isset( $this->fotorama_elevation_options['images_with_gps_required_5'] ) && $this->fotorama_elevation_options['images_with_gps_required_5'] === 'true' ) ? 'checked' : ''
		);
	}

	public function ignore_custom_sort_6_callback() {
		printf(
			'<input type="checkbox" name="fotorama_elevation_option_name[ignore_custom_sort_6]" id="ignore_custom_sort_6" value="ignore_custom_sort_6" %s> <label for="ignore_custom_sort_6">Ignore custom sort even if provided by Wordpress. Sort ascending by date taken if checked.</label>',
			( isset( $this->fotorama_elevation_options['ignore_custom_sort_6'] ) && $this->fotorama_elevation_options['ignore_custom_sort_6'] === 'true' ) ? 'checked' : ''
		);
	}

	public function show_address_of_start_7_callback() {
		printf(
			'<input type="checkbox" name="fotorama_elevation_option_name[show_address_of_start_7]" id="show_address_of_start_7" value="show_address_of_start_7" %s> <label for="show_address_of_start_7">Show address of starting point (taken from the first image or GPX-coordinate in the GPX-track)</label>',
			( isset( $this->fotorama_elevation_options['show_address_of_start_7'] ) && $this->fotorama_elevation_options['show_address_of_start_7'] === 'true' ) ? 'checked' : ''
		);
	}

	public function text_for_start_address_8_callback() {
		printf(
			'<input class="regular-text" type="text" required name="fotorama_elevation_option_name[text_for_start_address_8]" id="text_for_start_address_8" value="%s">',
			isset( $this->fotorama_elevation_options['text_for_start_address_8'] ) ? esc_attr( $this->fotorama_elevation_options['text_for_start_address_8']) : ''
		);
	}

	public function general_text_for_the_fotorama_alt_9_callback() {
		printf(
			'<input class="regular-text" type="text" name="fotorama_elevation_option_name[general_text_for_the_fotorama_alt_9]" id="general_text_for_the_fotorama_alt_9" value="%s">',
			isset( $this->fotorama_elevation_options['general_text_for_the_fotorama_alt_9'] ) ? esc_attr( $this->fotorama_elevation_options['general_text_for_the_fotorama_alt_9']) : ''
		);
	}

	public function height_of_map_10_callback() {
		printf(
			'<input type="number" min="'. $this->min_height_map .'" max="'. $this->max_height_map .'" name="fotorama_elevation_option_name[height_of_map_10]" id="height_of_map_10" value="%s"><label>  Min: %s px, Max: %s px</label>',
			isset( $this->fotorama_elevation_options['height_of_map_10'] ) ? esc_attr( $this->fotorama_elevation_options['height_of_map_10']) : '',
			$this->min_height_map, $this->max_height_map
		);
	}

	public function height_of_chart_11_callback() {
		printf(
			'<input type="number" min="'. $this->min_height_chart .'" max="'. $this->max_height_chart .'" name="fotorama_elevation_option_name[height_of_chart_11]" id="height_of_chart_11" value="%s"><label>  Min: %s px, Max: %s px</label>',
			isset( $this->fotorama_elevation_options['height_of_chart_11'] ) ? esc_attr( $this->fotorama_elevation_options['height_of_chart_11']) : '',
			$this->min_height_chart, $this->max_height_chart
		);
	}

	public function max_width_of_container_12_callback() {
		printf(
			'<input type="number" min="'. $this->min_width .'" max="'. $this->max_width .'" name="fotorama_elevation_option_name[max_width_of_container_12]" id="max_width_of_container_12" value="%s"><label>  Min: %s px, Max: %s px</label>',
			isset( $this->fotorama_elevation_options['max_width_of_container_12'] ) ? esc_attr( $this->fotorama_elevation_options['max_width_of_container_12']) : '',
			$this->min_width, $this->max_width
		);
	}

	public function useCDN_13_callback() {
		printf(
			'<input type="checkbox" name="fotorama_elevation_option_name[useCDN_13]" id="useCDN_13" value="useCDN_13" %s> <label for="useCDN_13">Use CDN for js- and css-Library-Files</label>',
			( isset( $this->fotorama_elevation_options['useCDN_13'] ) && $this->fotorama_elevation_options['useCDN_13'] === 'true' ) ? 'checked' : ''
		);
	}

	public function min_width_css_grid_row_14_callback() {
		printf(
			'<input type="number" min="'. $this->min_width/2 .'" max="'. $this->max_width .'" name="fotorama_elevation_option_name[min_width_css_grid_row_14]" id="min_width_css_grid_row_14" value="%s"><label>  Min: %s px, Max: %s px</label>',
			isset( $this->fotorama_elevation_options['min_width_css_grid_row_14'] ) ? esc_attr( $this->fotorama_elevation_options['min_width_css_grid_row_14']) : '480',
			$this->min_width/2, $this->max_width
		);
	}

	public function fit_callback() {
		?> <select name="fotorama_elevation_option_name[fit]" id="fit">
			<?php $selected = (isset( $this->fotorama_elevation_options['fit'] ) && $this->fotorama_elevation_options['fit'] === 'contain') ? 'selected' : '' ; ?>
			<option value="contain" <?php echo $selected; ?>>Contain</option>
			<?php $selected = (isset( $this->fotorama_elevation_options['fit'] ) && $this->fotorama_elevation_options['fit'] === 'cover') ? 'selected' : '' ; ?>
			<option value="cover" <?php echo $selected; ?>>Cover</option>
			<?php $selected = (isset( $this->fotorama_elevation_options['fit'] ) && $this->fotorama_elevation_options['fit'] === 'scaledown') ? 'selected' : '' ; ?>
			<option value="scaledown" <?php echo $selected; ?>>Scaledown </option>
			<?php $selected = (isset( $this->fotorama_elevation_options['fit'] ) && $this->fotorama_elevation_options['fit'] === 'none') ? 'selected' : '' ; ?>
			<option value="none" <?php echo $selected; ?>>None</option>
		</select> <?php
	}

	public function setCustomFields_15_callback() {
		printf(
			'<input type="checkbox" name="fotorama_elevation_option_name[setCustomFields_15]" id="setCustomFields_15" value="setCustomFields_15" %s> 
			<label for="setCustomFields_15">
			Set Custom Fields (geoadress, lat, lon, postimg) in post. Geoadress is for the address shown under the elevation chart. Lat.,Lon. is for the GPS-Coords used for the Overview-Map
			</label>',
			( isset( $this->fotorama_elevation_options['setCustomFields_15'] ) && $this->fotorama_elevation_options['setCustomFields_15'] === 'true' ) ? 'checked' : ''
		);
	}

	public function doYoastXmlSitemap_16_callback() {
		printf(
			'<input type="checkbox" name="fotorama_elevation_option_name[doYoastXmlSitemap_16]" id="doYoastXmlSitemap_16" value="doYoastXmlSitemap_16" %s> 
			<label for="doYoastXmlSitemap_16">Generate the Yoast XML-Sitemap with the images shown in the Fotorama-Slider. Used for SEO. Stored in Custom field `postimg`</label>',
			( isset( $this->fotorama_elevation_options['doYoastXmlSitemap_16'] ) && $this->fotorama_elevation_options['doYoastXmlSitemap_16'] === 'true' ) ? 'checked' : ''
		);
	}

	private function my_sanitize_path ($inp) {
		$inp = sanitize_text_field( $inp);
		$inp = filter_var($inp, FILTER_SANITIZE_STRING);
		$inp = preg_replace("/[^A-Za-z0-9-_\/]/", "", $inp);
		$inp = rtrim($inp,'/');
		$inp = rtrim($inp,'\\');
		$inp = ltrim($inp,'/');
		$inp = ltrim($inp,'\\');
		return $inp;
	}

	private function my_sanitize_text ($inp) {
		$inp = sanitize_text_field( $inp);
		$inp = filter_var($inp, FILTER_SANITIZE_STRING);
		return $inp;
	}

	private function my_sanitize_int_with_limits($inp, $min, $max) {
		$inp = preg_replace("/[^0-9]/", "", $inp);
		$val = intval( $inp);
		if (filter_var($val, FILTER_VALIDATE_INT, array("options" => array("min_range"=>$min, "max_range"=>$max))) === false) {
			// echo("Variable value is not within the legal range");
			($val < $min) ? $val = $min : $val = $max;
		} else {
			//echo("Variable value is within the legal range");
		}
		return strval($val);
	}

}


